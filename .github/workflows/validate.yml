name: Validate Plugin

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check plugin.json exists
        run: |
          if [ ! -f ".claude-plugin/plugin.json" ]; then
            echo "Error: plugin.json not found"
            exit 1
          fi
          echo "âœ“ plugin.json exists"

      - name: Check required files
        run: |
          required_files=(
            ".claude-plugin/plugin.json"
            "agents/insbot-agent.md"
            "commands/insbot.md"
            "commands/keyword.md"
            "commands/url.md"
            "commands/nurture.md"
            "skills/keyword-mode/SKILL.md"
            "skills/url-mode/SKILL.md"
            "skills/nurture-mode/SKILL.md"
            "README.md"
            "LICENSE"
          )
          missing=0
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âœ— Missing: $file"
              missing=$((missing + 1))
            else
              echo "âœ“ $file"
            fi
          done
          if [ $missing -gt 0 ]; then
            echo "Error: $missing required file(s) missing"
            exit 1
          fi

      - name: Validate plugin.json syntax
        run: |
          if command -v python3 &> /dev/null; then
            python3 -m json.tool .claude-plugin/plugin.json > /dev/null && echo "âœ“ plugin.json is valid JSON"
          else
            echo "Skipping JSON validation (python3 not available)"
          fi

      - name: Check frontmatter in commands
        run: |
          for cmd in commands/*.md; do
            if ! grep -q "^description:" "$cmd"; then
              echo "âœ— $cmd missing description frontmatter"
              exit 1
            fi
            echo "âœ“ $cmd has description"
          done

      - name: Check frontmatter in agents
        run: |
          for agent in agents/*.md; do
            if ! grep -q "^name:" "$agent" || ! grep -q "^description:" "$agent"; then
              echo "âœ— $agent missing required frontmatter (name, description)"
              exit 1
            fi
            if ! grep -q "^tools:" "$agent"; then
              echo "âœ— $agent missing tools frontmatter"
              exit 1
            fi
            echo "âœ“ $agent has required frontmatter"
          done

      - name: Summary
        run: |
          echo "## Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… plugin.json exists" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… All required files present" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Commands have frontmatter" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Agents have frontmatter" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Plugin validation passed! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
